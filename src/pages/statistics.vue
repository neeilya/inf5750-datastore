<template>
    <div>
        <div v-if="initializing" class="text-center">
            <spinner class="spinner"></spinner>
        </div>
        <div v-else>
            <md-card>
                <md-toolbar>
                    <span class="h3">Statistics</span>
                </md-toolbar>
                <md-card-content>
                    <div v-for="namespace in namespaces">
                        <pre>{{ namespace }}</pre>
                    </div>
                </md-card-content>
            </md-card>
        </div>
    </div>
</template>

<script type="text/babel">
    import spinner from 'components/assets/spinner.vue';
    import api from 'services/api';

    export default {
        data() {
            return {
                initializing: true,
                namespaces: []
            }
        },
        created() {
            this.fetch();
        },
        components: {
            spinner: spinner
        },
        methods: {
            fetch() {
                api.getAllNamespaces().then( response => {
                    for(let i = 0; i < response.data.length; ++i) {
                        let namespace = response.data[i];
                        let lastNamespace = (i === response.data.length - 1);

                        this.namespaces.push({
                            name: namespace,
                            keys: []
                        });

                        api.getAllKeysInNamespace(namespace).then(response => {
                            for(let j = 0; j < response.data.length; ++j) {
                                let item = response.data[j];
                                let lastItem = (j === response.data.length - 1);

                                api.getItemMetadata(namespace, item).then(response => {
                                    let item = response.data;

                                    this.namespaces[i].keys.push({
                                        id: item.id,
                                        key: item.key,
                                        sizeInBytes: item.value.length,
                                        created: item.created,
                                        lastUpdated: item.lastUpdated
                                    });

                                    if(lastNamespace && lastItem) {
                                        this.initializing = false;
                                    }
                                });
                            }
                        });
                    }
                });
            }
        }
    }
</script>

<style scoped>
    .spinner {
        margin-top: 50px;
    }
</style>